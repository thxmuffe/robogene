#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")"

ENV_FILE=""
if [ -f "./pop.env" ]; then
  ENV_FILE="./pop.env"
elif [ -f "../pop.env" ]; then
  ENV_FILE="../pop.env"
fi

if [ -n "${ENV_FILE}" ]; then
  set -a
  # shellcheck disable=SC1091
  . "${ENV_FILE}"
  set +a
fi

if [ -z "${OPENAI_API_KEY:-}" ]; then
  echo "Warning: OPENAI_API_KEY is not set in environment."
fi

if lsof -iTCP:7071 -sTCP:LISTEN -n -P >/dev/null 2>&1; then
  echo "Port 7071 is already in use. Stop that process first."
  lsof -iTCP:7071 -sTCP:LISTEN -n -P || true
  exit 1
fi

if [ ! -f backend/local.settings.json ]; then
  cat > backend/local.settings.json <<'JSON'
{
  "IsEncrypted": false,
  "Values": {
    "FUNCTIONS_WORKER_RUNTIME": "node",
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "ROBOGENE_ALLOWED_ORIGIN": "http://localhost:8080,http://127.0.0.1:8080,http://localhost:5500,http://127.0.0.1:5500,http://localhost:3000,http://127.0.0.1:3000,http://localhost:5173,http://127.0.0.1:5173"
  }
}
JSON
fi

npm run watch:all &
WATCH_PID=$!

ROBOGENE_ALLOWED_ORIGIN="http://localhost:8080,http://127.0.0.1:8080,http://localhost:5500,http://127.0.0.1:5500,http://localhost:3000,http://127.0.0.1:3000,http://localhost:5173,http://127.0.0.1:5173" \
ROBOGENE_USE_LEGACY_BACKEND="1" \
  npm run backend:start &
API_PID=$!

trap 'kill $WATCH_PID $API_PID 2>/dev/null || true' EXIT INT TERM

echo "Frontend: http://localhost:8080"
echo "Backend API: http://localhost:7071"
echo "Local backend mode: legacy"

wait
