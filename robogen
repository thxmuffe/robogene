#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")"

ENV_FILE=""
if [ -f "./pop.env" ]; then
  ENV_FILE="./pop.env"
elif [ -f "../pop.env" ]; then
  ENV_FILE="../pop.env"
fi

if [ -n "${ENV_FILE}" ]; then
  set -a
  # shellcheck disable=SC1091
  . "${ENV_FILE}"
  set +a
fi

if [ -z "${OPENAI_API_KEY:-}" ]; then
  echo "Warning: OPENAI_API_KEY is not set in environment."
fi

if [ -z "${ROBOGENE_STORAGE_CONNECTION_STRING:-}" ] && [ -z "${AzureWebJobsStorage:-}" ]; then
  echo "Error: set ROBOGENE_STORAGE_CONNECTION_STRING (or AzureWebJobsStorage) to a real Azure Storage connection string."
  echo "Local Azurite (UseDevelopmentStorage=true) is not used in this setup."
  exit 1
fi

STORAGE_CONN="${ROBOGENE_STORAGE_CONNECTION_STRING:-${AzureWebJobsStorage:-}}"

if lsof -iTCP:7071 -sTCP:LISTEN -n -P >/dev/null 2>&1; then
  echo "Port 7071 is already in use. Stop that process first."
  lsof -iTCP:7071 -sTCP:LISTEN -n -P || true
  exit 1
fi

cat > backend/local.settings.json <<JSON
{
  "IsEncrypted": false,
  "Values": {
    "FUNCTIONS_WORKER_RUNTIME": "node",
    "AzureWebJobsStorage": "${STORAGE_CONN}",
    "ROBOGENE_STORAGE_CONNECTION_STRING": "${STORAGE_CONN}",
    "ROBOGENE_ALLOWED_ORIGIN": "http://localhost:8080,http://127.0.0.1:8080,http://localhost:5500,http://127.0.0.1:5500,http://localhost:3000,http://127.0.0.1:3000,http://localhost:5173,http://127.0.0.1:5173"
  }
}
JSON

echo "Building backend..."
npm run build:backend

npm run watch &
WATCH_PID=$!

ROBOGENE_ALLOWED_ORIGIN="http://localhost:8080,http://127.0.0.1:8080,http://localhost:5500,http://127.0.0.1:5500,http://localhost:3000,http://127.0.0.1:3000,http://localhost:5173,http://127.0.0.1:5173" \
  npm run backend:start &
API_PID=$!

trap 'kill $WATCH_PID $API_PID 2>/dev/null || true' EXIT INT TERM

echo "Frontend: http://localhost:8080"
echo "Backend API: http://localhost:7071"

wait
