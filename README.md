# RoboGene

Interactive story-to-image app.

- Frontend is ClojureScript + Re-frame/Reagent.
- Frontend sources: `src/robogene/frontend/`
- Frontend build output: `js/main.js` (generated by build/CI)
- Backend is Azure Functions app in `backend/`

## Frontend build
Prereqs:
- Node 20+
- Java + Clojure CLI (needed by `shadow-cljs`)

From repo root:

```bash
npm install
npm run build
```

For local dev watch:

```bash
npm run watch
```

## Frontend host (GitHub Pages)
Pages is deployed via GitHub Actions workflow: `.github/workflows/pages.yml`.
Set repository Pages source to `GitHub Actions`.

Set backend origin in `index.html`:

```html
<script>
  window.ROBOGENE_API_BASE = "https://<your-function-app>.azurewebsites.net";
</script>
```

## Backend local run (Azure Functions)
Prereqs:
- Node 20+
- Azure Functions Core Tools v4 (`func`)

From repo root:

```bash
cd backend
npm install
cp local.settings.json.example local.settings.json
# set OPENAI_API_KEY in local.settings.json
func start
```

API endpoints (local):
- `GET http://localhost:7071/api/state`
- `POST http://localhost:7071/api/generate-next`

## Deploy backend to Azure Functions
Use a writable Azure CLI config path in this workspace:

```bash
export AZURE_CONFIG_DIR=/Users/penpa/Desktop/PDFs/robogene/.azure
az login
```

Create resources (example):

```bash
RG=robogene-rg
LOC=eastus
ST=robogenest$RANDOM
PLAN=robogene-plan
APP=robogene-func-$RANDOM

az group create -n $RG -l $LOC
az storage account create -g $RG -n $ST -l $LOC --sku Standard_LRS
az functionapp plan create -g $RG -n $PLAN --location $LOC --number-of-workers 1 --sku B1 --is-linux
az functionapp create -g $RG -p $PLAN -n $APP -s $ST --runtime node --runtime-version 20 --functions-version 4
```

Set app settings:

```bash
az functionapp config appsettings set -g $RG -n $APP --settings \
  OPENAI_API_KEY="<your_key>" \
  ROBOGENE_IMAGE_MODEL="gpt-image-1" \
  ROBOGENE_ALLOWED_ORIGIN="https://thxmuffe.github.io,http://localhost:8080,http://127.0.0.1:8080,http://localhost:5500,http://127.0.0.1:5500,http://localhost:3000,http://127.0.0.1:3000,http://localhost:5173,http://127.0.0.1:5173"
```

Deploy from `backend/`:

```bash
cd backend
npm install
zip -r deploy.zip . -x '*.git*' 'local.settings.json' 'node_modules/*'
az functionapp deployment source config-zip -g $RG -n $APP --src deploy.zip
```

Then set frontend API base to:
- `https://$APP.azurewebsites.net`

Or run the helper script:

```bash
export AZURE_CONFIG_DIR=/Users/penpa/Desktop/PDFs/robogene/.azure
export OPENAI_API_KEY="<your_key>"
cd backend
./deploy_azure.sh robogene-rg eastus robogene-func-prod
```

If your subscription has no Basic plan quota, use Consumption deploy:

```bash
export AZURE_CONFIG_DIR=/Users/penpa/Desktop/PDFs/robogene/.azure
export OPENAI_API_KEY="<your_key>"
cd backend
./deploy_azure_consumption.sh robogene-rg eastus robogene-func-prod
```

## Notes
- This backend stores story state in-memory per function instance.
- Generated images are returned as `scene.imageDataUrl` (base64) for portability.
- Deploy package must include `node_modules` for this zip-deploy flow.
- `js/` build artifacts are not committed; CI builds them for Pages.
