# RoboGene

Interactive story-to-image app.

- Frontend is ClojureScript + Re-frame/Reagent.
- Frontend sources: `src/robogene/frontend/`
- Frontend build output: `js/main.js` (generated by build/CI)
- Backend is Azure Functions app in `backend/`
- Backend source is ClojureScript: `src/robogene/backend/api.cljs`
- Azure entrypoint is `backend/src/functions/api.js` (loads generated `api_compiled.js`)

## Frontend build
Prereqs:
- Node 20+
- Java + Clojure CLI (needed by `shadow-cljs`)

From repo root:

```bash
npm install
npm run build
```

Build backend (ClojureScript -> Azure Functions JS):

```bash
npm run build:backend
```

Run tests:

```bash
# fast unit/integration tests
npm test

# backend end-to-end test (starts Azure Functions locally on a test port)
npm run test:e2e

# everything
npm run test:all
```

For local dev watch:

```bash
npm run watch
```

Or use the root helper script to run frontend + backend local stack together:

```bash
./robogen
```

This starts:
- Frontend + backend ClojureScript watcher (`shadow-cljs watch app backend`)
- Backend API host (`npm run backend:start`) on `http://localhost:7071`

It prints the frontend URL and keeps all local processes running.
When opened on `localhost`, the frontend automatically uses `http://localhost:7071` as API base.

## Frontend host (GitHub Pages)
Pages is deployed via GitHub Actions workflow: `.github/workflows/pages.yml`.
Set repository Pages source to `GitHub Actions`.

Set backend origin in `index.html`:

```html
<script>
  window.ROBOGENE_API_BASE = "https://<your-function-app>.azurewebsites.net";
</script>
```

## Backend local run (Azure Functions)
Prereqs:
- Node 20+
- Azure Functions Core Tools v4 (`func`)

From repo root:

```bash
cd backend
npm install
cp local.settings.json.example local.settings.json
# set OPENAI_API_KEY in local.settings.json
# from repo root once:
# npm run build:backend
func start
```

API endpoints (local):
- `GET http://localhost:7071/api/state`
- `POST http://localhost:7071/api/generate-frame` with body `{ "frameId": "...", "direction": "..." }`

Note:
- `npm run build:backend` is defined in the repo root `package.json`, not in `backend/package.json`.

## Deploy backend to Azure Functions
Use a writable Azure CLI config path in this workspace:

```bash
export AZURE_CONFIG_DIR=/Users/penpa/Desktop/PDFs/robogene/.azure
az login
```

Create resources (example):

```bash
RG=robogene-rg
LOC=eastus
ST=robogenest$RANDOM
PLAN=robogene-plan
APP=robogene-func-$RANDOM

az group create -n $RG -l $LOC
az storage account create -g $RG -n $ST -l $LOC --sku Standard_LRS
az functionapp plan create -g $RG -n $PLAN --location $LOC --number-of-workers 1 --sku B1 --is-linux
az functionapp create -g $RG -p $PLAN -n $APP -s $ST --runtime node --runtime-version 20 --functions-version 4
```

Set app settings:

```bash
az functionapp config appsettings set -g $RG -n $APP --settings \
  OPENAI_API_KEY="<your_key>" \
  ROBOGENE_IMAGE_MODEL="gpt-image-1" \
  ROBOGENE_ALLOWED_ORIGIN="https://thxmuffe.github.io,http://localhost:8080,http://127.0.0.1:8080,http://localhost:5500,http://127.0.0.1:5500,http://localhost:3000,http://127.0.0.1:3000,http://localhost:5173,http://127.0.0.1:5173"
```

Deploy from `backend/`:

```bash
cd backend
npm install
zip -r deploy.zip . -x '*.git*' 'local.settings.json' 'node_modules/*'
az functionapp deployment source config-zip -g $RG -n $APP --src deploy.zip
```

GitHub Actions deploy (`.github/workflows/azure-functions.yml`) supports two auth modes:

1. Publish profile (simplest):
   - Set repo secret `AZURE_FUNCTIONAPP_PUBLISH_PROFILE` from:
     - Azure Portal -> Function App -> `Get publish profile`
2. OIDC (no long-lived secret):
   - Set repo secrets `AZURE_CLIENT_ID`, `AZURE_TENANT_ID`, `AZURE_SUBSCRIPTION_ID`
   - In Azure AD App Registration, add a Federated Credential for your GitHub repo/branch

If neither auth mode is configured, the workflow now fails early with a clear error listing missing secrets.

Then set frontend API base to:
- `https://$APP.azurewebsites.net`

Or run the helper script:

```bash
export AZURE_CONFIG_DIR=/Users/penpa/Desktop/PDFs/robogene/.azure
export OPENAI_API_KEY="<your_key>"
cd backend
./deploy_azure.sh robogene-rg eastus robogene-func-prod
```

If your subscription has no Basic plan quota, use Consumption deploy:

```bash
export AZURE_CONFIG_DIR=/Users/penpa/Desktop/PDFs/robogene/.azure
export OPENAI_API_KEY="<your_key>"
cd backend
./deploy_azure_consumption.sh robogene-rg eastus robogene-func-prod
```

## Notes
- This backend stores story state in-memory per function instance.
- Backend state is frame-centric: every frame has a unique `frameId`.
- Generated images are returned as `frame.imageDataUrl` (base64) for portability.
- Deploy package must include `node_modules` for this zip-deploy flow.
- `js/` build artifacts are not committed; CI builds them for Pages.

## Troubleshooting
- `500` with message like `... is not a function` on backend routes:
  - Stop all `func start` processes.
  - Rebuild backend from repo root: `npm run build:backend`.
  - Restart backend from `backend/`: `npm run start -- --verbose`.
- If `func start` fails because port `7071` is in use, stop the existing process first or pass `--port`.
