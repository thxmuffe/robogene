name: Deploy App

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  pages: write

jobs:
  build-webapi:
    name: Build webapi
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@13.2
        with:
          cli: latest

      - name: Build ClojureScript webapi
        run: |
          npm ci
          npm run build:webapi

      - name: Prepare Azure package
        run: |
          ./.github/azure_deploy/package_webapi_dist.sh

      - name: Smoke check packaged webapi
        run: |
          set -euo pipefail
          rm -rf /tmp/robogene-webapi-smoke
          mkdir -p /tmp/robogene-webapi-smoke
          unzip -q dist/release/webapi/webapi_dist.zip -d /tmp/robogene-webapi-smoke
          test -f /tmp/robogene-webapi-smoke/host.json
          test -f /tmp/robogene-webapi-smoke/story_routes_host.js
          test -f /tmp/robogene-webapi-smoke/dist/webapi_compiled.js
          test -f "/tmp/robogene-webapi-smoke/ai/robot emperor/references/robot_emperor_ep22_p01.png"
          (
            cd /tmp/robogene-webapi-smoke
            AzureWebJobsStorage='UseDevelopmentStorage=true' node -e "require('./story_routes_host.js'); console.log('webapi-smoke-ok')"
          )

      - name: Upload Web API deploy artifact
        uses: actions/upload-artifact@v4
        with:
          name: robogen-webapi
          path: dist/release/webapi/webapi_dist.zip
          retention-days: 7

  deploy-webapi:
    name: Deploy webapi to Azure
    runs-on: ubuntu-latest
    needs: build-webapi
    env:
      FUNCTION_APP_NAME: robogene-func-prod
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_FUNCTIONAPP_PUBLISH_PROFILE: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
    steps:
      - name: Download Web API deploy artifact
        uses: actions/download-artifact@v4
        with:
          name: robogen-webapi
          path: dist/release/webapi

      - name: Resolve deploy auth mode
        id: auth
        run: |
          set -euo pipefail
          if [[ -n "${AZURE_FUNCTIONAPP_PUBLISH_PROFILE:-}" ]]; then
            echo "mode=publish-profile" >> "$GITHUB_OUTPUT"
            echo "Using publish profile authentication."
          elif [[ -n "${AZURE_CLIENT_ID:-}" && -n "${AZURE_TENANT_ID:-}" && -n "${AZURE_SUBSCRIPTION_ID:-}" ]]; then
            echo "mode=oidc" >> "$GITHUB_OUTPUT"
            echo "Using OIDC authentication."
          else
            echo "::error::Missing Azure deployment credentials."
            echo "::error::Set either AZURE_FUNCTIONAPP_PUBLISH_PROFILE, or all of AZURE_CLIENT_ID/AZURE_TENANT_ID/AZURE_SUBSCRIPTION_ID."
            exit 1
          fi

      - name: Azure login (OIDC)
        if: steps.auth.outputs.mode == 'oidc'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Azure context
        if: steps.auth.outputs.mode == 'oidc'
        run: az account show --output table

      - name: Deploy Azure Function (OIDC)
        if: steps.auth.outputs.mode == 'oidc'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.FUNCTION_APP_NAME }}
          package: ./dist/release/webapi/webapi_dist.zip

      - name: Deploy Azure Function (publish profile)
        if: steps.auth.outputs.mode == 'publish-profile'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.FUNCTION_APP_NAME }}
          package: ./dist/release/webapi/webapi_dist.zip
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}

      - name: Health check deployed webapi
        run: |
          set -euo pipefail
          api_url="https://${FUNCTION_APP_NAME}.azurewebsites.net/api/state?t=$(date +%s)"
          echo "Checking $api_url"
          for i in {1..30}; do
            if curl -fsS --max-time 10 "$api_url" >/dev/null; then
              echo "Web API is healthy."
              exit 0
            fi
            echo "Health check attempt $i/30 failed; retrying in 5s..."
            sleep 5
          done
          echo "::error::Web API health check failed after deployment."
          exit 1

  build-webapp:
    name: Build webapp
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Clojure
        uses: DeLaGuardo/setup-clojure@13.2
        with:
          cli: latest

      - name: Build webapp
        run: |
          npm ci
          npm run build
          mkdir -p dist/release/webapp
          cp src/webapp/index.html src/webapp/styles.css dist/release/webapp/

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          name: robogen-webapp
          path: dist/release/webapp

  deploy-pages:
    name: Deploy webapp to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-webapp
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    concurrency:
      group: pages
      cancel-in-progress: true
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: robogen-webapp
